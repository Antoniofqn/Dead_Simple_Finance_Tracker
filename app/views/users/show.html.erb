<div class= "container col-12 mb-5 pb-5" style="margin-top: 20px">
  <div class="container justify-content-center">
    <div class="card mb-3" style="border-radius: 15px;">
      <div class="d-flex justify-content-around">
          <div class="d-flex flex-column align-items-center p-2">
            <h5 class="card-title" style="text-align:center;">Welcome <%= @user.first_name %>!</h5>
            <%= user_has_photo?(current_user) %>

            <div class="d-flex flex-column mt-3 p-2" style="border-radius: 20px; box-shadow: 0 14px 21px 0 rgba(0,0,0,.06);">
              <% if current_user.goals.last.nil?  %>
                <h4 data-bs-toggle="modal" data-bs-target="#form-goal">Create Goal</h4>
              <% elsif current_user.goals.last.achieved %>
                <h4><% current_user.goals.last.name %> Achieved!</h4>
                <h4 data-bs-toggle="modal" data-bs-target="#form-goal">Create New Goal</h4>
              <% elsif current_user.goals.last.cancelled%>
                <h4 data-bs-toggle="modal" data-bs-target="#form-goal">Create New Goal</h4>
              <% else %>
                <h4>Current Goal: <%= current_user.goals.last.name %></h4>
              <% end %>
              <% unless current_user.goals.last.nil? || current_user.goals.last.achieved || current_user.goals.last.cancelled %>
                <div>
                  <h6>Goal: R$ <%= current_user.goals.last.objective %>,00</h6>
                  <h6>Savings: R$ <%= current_user.goals.last.current_value %>,00</h6>
                  <h6>Add</h6>
                  <h6>Cancel</h6>
                </div>
              <% end %>
            </div>
          </div>

          <div class="info-box">
            <div class="saldo-box">
              <h3>Monthly Balance: <br>
              R$ <%= format("%.2f", @user.fetch_monthly_income.to_f - @user.fetch_monthly_expense.to_f) %></h1>
            </div>
            <div class="both-details-box">
              <div class="details-box" style="margin-right: 5px;">
                <p style="color: green;">R$ <%= @user.fetch_monthly_income %></p>
                <p>Monthly Income</p>
              </div>
              <div class="details-box">
                <p style="color: red;">R$ <%= @user.fetch_monthly_expense %></p>
                <p>Monthly Expenses</p>
              </div>
            </div>
          </div>
        <div>
          <div class="mb-3 p-2" style="border-radius: 10px; padding:10px; margin: 3px 6px; max-width:30%; max-width:100%">
            <div class="row g-0">
              <h1 style="text-align:center; opacity: 0.7;">Quick Actions</h1>
            </div>
            <div class="container quick-action-buttons">
              <div class="card-quick" data-bs-toggle="modal" data-bs-target="#form-income">
                <h1 style="color: green;">+</h1>
                <p>Add Income</p>
              </div>
              <div class="card-quick" data-bs-toggle="modal" data-bs-target="#form-expense">
                <h1 style="color: red;">-</h1>
                <p>Add Expense</p>
              </div>
              <div class="card-quick">
                <h2><%= link_to "Stats", stats_path, class: "text-decoration-none" %></h2>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%= simple_form_for :stats, url: user_path(anchor: "pie-chart"), method: "GET", html: { class: 'form-inline' } do |f| %>
          <%= f.input :date, as: :date, discard_day: true, order: [:month, :year] %>
          <%= f.submit "Search", class: "btn btn-primary" %>
        <% end %>

  <div class="container flex-direction-row-center justify-content-between mb-4 pb-3">
     <div class="card col-md-5 p-2" style= "border-radius: 15px;" id="balance-chart">
      <h2>Monthly Balance View</h2>

      <% if params.has_key?(:stats)%>
        <h3><%= Date::MONTHNAMES[params[:stats]["date(2i)"].to_i] %> - <%= params[:stats]["date(1i)"] %></h3>
      <% else %>
        <h3><%= Date::MONTHNAMES[Date.today.month] %> - <%= Date.today.year %></h3>
      <% end %>

      <% if params.has_key?(:stats)%>
        <%= column_chart @user.transactions.where(transactions: {date: Date.new(params[:stats]["date(1i)"].to_i, params[:stats]["date(2i)"].to_i, 1)..Date.new(params[:stats]["date(1i)"].to_i, params[:stats]["date(2i)"].to_i).end_of_month}).group(:type_transaction).sum(:value), prefix: "R$ " %>
      <% else %>
        <%= column_chart @user.transactions.where(transactions: { date: Time.now.beginning_of_month..Time.now.end_of_month }).group(:type_transaction).sum(:value), prefix: "R$ " %>
      <% end %>
    </div>

    <div class="card col-md-5 p-2" style= "border-radius: 15px;" id="pie-chart">
      <h2>Monthly Expenses per Category</h2>

      <% if params.has_key?(:stats)%>
        <h3><%= Date::MONTHNAMES[params[:stats]["date(2i)"].to_i] %> - <%= params[:stats]["date(1i)"] %></h3>
      <% else %>
        <h3><%= Date::MONTHNAMES[Date.today.month] %> - <%= Date.today.year %></h3>
      <% end %>

      <% if params.has_key?(:stats) %>
        <%= pie_chart @user.transactions.where(transactions: {category: Transaction::EXPENSE_CATEGORIES, date: Date.new(params[:stats]["date(1i)"].to_i, params[:stats]["date(2i)"].to_i, 1)..Date.new(params[:stats]["date(1i)"].to_i, params[:stats]["date(2i)"].to_i).end_of_month}).group(:category).sum(:value), prefix: "R$ ", legend: "bottom" %>
      <% else %>
        <%= pie_chart @user.transactions.where(transactions: {category: Transaction::EXPENSE_CATEGORIES, date: Time.now.beginning_of_month..Time.now.end_of_month}).group(:category).sum(:value), prefix: "R$ ", legend: "bottom" %>
      <% end %>
    </div>
  </div>
</div>


<!-- Modal -->
<div class="modal fade" id="form-income" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" style="padding:50px">
      <%= render "form_income", transaction: @transaction %>
    </div>
  </div>
</div>

<div class="modal fade" id="form-expense" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" style="padding:50px">
      <%= render "form_expense", transaction: @transaction %>
    </div>
  </div>
</div>

<div class="modal fade" id="form-goal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" style="padding:50px">
      <%= render "form_goal", goal: @goal %>
    </div>
  </div>
</div>
